name: "tuf-conformance"
description: "TUF client conformance test suite"

inputs:
  entrypoint:
    description: "client-under-test CLI to invoke"
    required: true
  expected-failures:
    description: "Optional list test names expected to fail"
    default: ""
    required: false

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f # v5.1.1
      with:
        python-version: "3.11"
        cache: "pip"

    - name: Install test
      run: |
        echo "::group::Install test suite and dependencies"
        sudo apt install faketime
        pip install -e "${{ github.action_path }}"
        echo "::endgroup::"
      shell: bash

    - name: Run test suite
      id: tuf-conformance
      env:
        ENTRYPOINT: ${{ inputs.entrypoint }}
        EXPECTED_FAILURES: ${{ inputs.expected-failures }}
        TEST_LOCATION: ${{ github.action_path }}/tuf_conformance
      run: |
        # create a sanitized name for the artifact upload
        echo "NAME=${ENTRYPOINT##*/}" >> "$GITHUB_OUTPUT"

        # run test suite
        pytest -v "$TEST_LOCATION" \
          --entrypoint "$ENTRYPOINT" \
          --expected-failures "$EXPECTED_FAILURES" \
          --repository-dump-dir ./test-repositories \
      shell: bash

    - name: Upload repository dump
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
      with:
        name: test repositories for '${{ steps.tuf-conformance.outputs.NAME }}'
        path: test-repositories